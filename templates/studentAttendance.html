<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>后端管理</title>
		<meta name="keywords" content="后端管理">
		<meta name="description" content="后端管理">

		<link href="css/bootstrap.min.css" rel="stylesheet">
		<link href="css/font-awesome.min.css" rel="stylesheet">
		<link href="css/animate.min.css" rel="stylesheet">
		<link href="css/style.min.css" rel="stylesheet">
		<link href="css/pager.css" rel="stylesheet" type="text/css" />
		<link href="css/style.css" rel="stylesheet" type="text/css" />
		<link href="js/plugins/layer/skin/default/layer.css" rel="stylesheet" type="text/css" />
		<link href="css/layui.css" media="all" rel="stylesheet">
		<link href="css/jquery.monthpicker.css" rel="stylesheet" type="text/css" >
		<link href="css/calendar-pro.css" rel="stylesheet" type="text/css" >

		<script src="js/jquery.min.js"></script>
        
	</head>
   <style>
   	#class-name{
   		width: 180px;
   	}
   	.topInfo{
   		width: 100%;
   		min-height: 30px;
   		border-bottom: 1px solid #efefef;
   		background: #ecf0f3;
   		padding: 0px 20px;
   	}
	.sculpture{
		width: 70px;
	    height: 70px;
	    border-radius: 50%;
	    margin-right: 20px;
	    background: url(./img/a9.jpg);
	    background-size: 100%;
	}
	.studentInfo{
		line-height: 28px;
	}
	.common-width40{
		border-right:1px solid #e2e2e2;
		padding: 20px 0px;
	}
	.common-width60{
		padding: 20px;
	}
	.clearfix{
		clear: both;
	}
	h3,.studentName{
	    font-weight: bold;
	    margin-bottom: 5px;
	}
	.attendance{
		min-width: 115px;
		line-height: 26px;
		font-size: 14px;
	}
	.calendar-box{
		padding: 10px 20px;
	}
	.calendarTip{
		width: 50%;
		line-height: 28px;
	}
	.calendarTipPart{
		padding: 0px 0px 0px 40px
	}
	.calendarTipPart .calendarTip span{
		width: 10px;
	    height: 4px;
	    display: inline-block;
	    float: left;
	    margin-top: 12px;
	    margin-right: 5px;
	}
	.calendarTipPart .calendarTip .calendarTip1{
		background: #a94442;
	}
	.calendarTipPart .calendarTip .calendarTip2{
		background: #bd814b;
	}
	.calendarTipPart .calendarTip .calendarTip3{
		background: #7b500e;
	}
	.calendarTipPart .calendarTip .calendarTip4{
		background: #9a9045;
	}
	.calendarTipPart .calendarTip .calendarTip5{
		background: #729042;
	}
	.calendarTipPart .calendarTip .calendarTip6{
		background: #72d46d;
	}
	.calendarTipPart .calendarTip .calendarTip7{
		background: #405d94;
	}
	.calendarTipPart .calendarTip .calendarTip8{
		background: #1ba0e7;
	}
	.ht-rili-datebox{
		display: none;
	}
   </style>
	<body class="gray-bg">
		<div class="wrapper wrapper-content animated fadeIn">
			<div class="row">
				<div class="col-sm-12">
					<div class="tabs-container">
						<div class="panel-body">
							<div class="wrapper wrapper-content animated fadeInRight">
								<div class="row">
									<div class="col-sm-12">
										<div class="bgBackground">
											<div class="ibox-title-Myown1">
												<div class="zx_searchTit">
													<div class="sendInquiry2" style="float: left;">
														<label class="control-label">月份：</label>
														<input type="text" class="input" id="monthly">
													</div>
													<div class="sendInquiry2" style="float: left;">
														<label class="control-label">所在年级：</label>
														<select id="grade-name">
															<option value="">--请选择年级--</option>
														</select>
													</div>
													<div class="sendInquiry2" style="float: left;">
														<label class="control-label">所在班级：</label>
														<select id="class-name">
															<option value="">--请选择班级-</option>
														</select>
													</div>
													<div class="sendInquiry2" style="float: left;">
														<label class="control-label">学生姓名：</label>
														<input type="text" name="" value="" id="student-name" />
													</div>
													<div class="sendInquiry0 col-sm-4" style="position: relative; margin:3.5px 0 0 0;">
														<button class="btn btn-primary btn-myown" id="searchBtn">查询</button>
													</div>
													<div style="clear: both;"></div>
												</div>
											</div>
											<div class="ibox-content">
												<table class="table table-striped table-bordered table-hover dataTables-example">
													<thead>
														<tr class="zx_checkedAll">
															<th colspan="6" style="text-align: left; background: none;padding: 10px 0px;">
																<button class="btn btn-primary btn-myown" id="downLoad">导出月考勤表</button>
															</th>
														</tr>
														<tr class="zx_thTitle">
															<th>序号</th>
															<th>年级</th>
															<th>姓名</th>
															<th>月份</th>
															<th>月签到统计</th>
															<th>迟到</th>
															<th>早退</th>
															<th style="width: 120px;">操作</th>
														</tr>
													</thead>
													<tbody id="tbody">

													</tbody>
												</table>
												<div id="layPage"></div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

			</div>
		</div>

		<!--详情内容-->
		<div id="addAttendanceContent" style="display: none; width: 500px; padding: 0px 0px;">
			<div class="topInfo">
				<div class="common-width40 fl">
					<div class="sculpture fl">
					</div>
					<div class="studentInfo studentName"></div>
					<div class="studentInfo studentGrade"></div>
					<div class="studentInfo studentClass"></div>
					<div class="clearfix"></div>
				</div>
				<div class="common-width60 fl attendanceInfo">
					<h3><span class="year">2018</span>年<span class="month">18</span>月考勤统计</h3>
					<div class="attendance fl">出勤：<span></span>天</div>
					<div class="attendance fl">迟到：<span></span>天</div>
					<div class="attendance fl">早退：<span></span>天</div>
				</div>
				<div class="clear"></div>
			</div>
			<div class="calendar-box calendar-layer clearfix"></div>
			<div class="calendarTipPart">
				<div class="calendarTip fl"><span class="calendarTip1"></span>上午正常打卡，下午未打卡</div>
				<div class="calendarTip fl"><span class="calendarTip2"></span>上午迟到，下午未打卡</div>
				<div class="calendarTip fl"><span class="calendarTip3"></span>上午未打卡，下午正常打卡</div>
				<div class="calendarTip fl"><span class="calendarTip4"></span>上午未打卡，下午早退</div>
				<div class="calendarTip fl"><span class="calendarTip5"></span>上午正常打卡，下午早退</div>
				<div class="calendarTip fl"><span class="calendarTip6"></span>上午迟到，下午正常打卡</div>
				<div class="calendarTip fl"><span class="calendarTip7"></span>上午迟到，下午早退</div>
				<div class="calendarTip fl"><span class="calendarTip8"></span>出勤</div>
			</div>
		</div>
		

		<script src="js/bootstrap.min.js"></script>
		<script src="js/plugins/layer/layer.js"></script>
		<script src="js/jquery.validate.min.js"></script>
		<script src="js/jquery.form.js"></script>
		<script src="js/layui.js" charset="utf-8"></script>
		<script src="js/jquery.monthpicker.js"></script>
		<script src="js/calendar-pro.js"></script>
		<script src="js/common.js" charset="utf-8"></script>
		<script type="text/javascript">
			$(document).ready(function() {
				//搜索框-月份
				$('#monthly').monthpicker({
					years: [2019,2018, 2017, 2016, 2015, 2014],
			        topOffset: 6
				})
				//获取学校
				var schoolSelect = JSON.parse(localStorage.getItem("school"));
			    var school = schoolSelect.id;  
			    var cardcode = schoolSelect.cardcode;
			    
			    //获取年级
				gradeInput();

				function gradeInput() {
					var data = {
						"limit": 20,
						"offset": 1,
						'school_id': school,
					}
					$.ajax({
						method: 'GET',
						xhrFields: {
							"withCredentials": true
						},
						contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
						url: "/grade/infos",
						data: data,
						dataType: 'json',
						jsonpCallback: '',
						cache: false,
						timeout: "1000000",
						success: function(msg) {
							var str = '<option value="">--请选择年级--</option>';
							var layerSrt = '';
							if(msg.data.length > 0) {
								for(var i = 0; i < msg.data.length; i++) {
									str += '<option value=' + msg.data[i].id + '>' + msg.data[i].name + '</option>';
								}
								$("#grade-name").html(str);

							} else {
								$("#grade-name").html('<option value="">---无---</option>');

							}
						},
						complete: function(XMLHttpRequest, status) {

						}
					})

				}

				//切换年级
				$("#grade-name").change(function() {
                    if($("#grade-name").val() == ''||undefined){
						$("#class-name").html('<option value="">---请选择班级---</option>');
					}else{
						classInput({
							"limit": 20,
							"offset": 1,
							'school_id': school,
							"grade_id": $("#grade-name").val() == '' ? undefined : $("#grade-name").val(),
						});
					}
				});
			    
			    //获取班级
				function classInput(data) {
					$.ajax({
						method: 'GET',
						xhrFields: {
							"withCredentials": true
						},
						contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
						url: "/class/infos",
						data: data,
						dataType: 'json',
						jsonpCallback: '',
						cache: false,
						timeout: "1000000",
						success: function(msg) {
							var str = '';
							var layerSrt = '';
							if(msg.data.length > 0) {
								for(var i = 0; i < msg.data.length; i++) {
									str += '<option value=' + msg.data[i].id + '>' + msg.data[i].name + '</option>';
								}
								$("#class-name").html(str);
							} else {
								$("#class-name").html('<option value="">---无---</option>');
							}
						},
						complete: function(XMLHttpRequest, status) {

						}
					})

				}
			    
				//获取列表
				getAjaxData({
					"school_id": school,
					"limit": 20,
					"offset": 1,
				});

				function getAjaxData(senddata) {
					$.ajax({
						type: "GET",
						contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
						url: "/student_sign/combination_infos",
						async: false,
						data: senddata,
						timeout: "30000",
						success: function(msg) {
							var msg = JSON.parse(msg);console.log(msg)
							//分页
							layui.use(['laypage', 'layer'], function() {
									var page = layui.laypage;
									page.render({
										elem: "layPage",
										count: msg.count,
										curr: senddata.offset,
										limit: senddata.limit,
										layout: ['count', 'prev', 'page', 'next', 'limit', 'skip'],
										jump: function(e, first) {
											if(!first) {
												senddata.offset = e.curr;
												senddata.limit = e.limit;
												var district = "";
												getAjaxData({
													"grade_id": $("#grade-name").val() == '' ? undefined : $("#grade-name").val(),
													"class_id": $("#class-name").val() == '' ? undefined : $("#class-name").val(),
													"date": $("#monthly").val() == '' ? undefined : $("#monthly").val(),
													"student_name": $("#student-name").val() == '' ? undefined : $("#student-name").val(),
													"school_id": school,
													"limit": 20,
													"offset": 1,
												});
											}
										}
									})
								})
								//表格渲染
							var strs = '';
							if(msg.data.length > 0) {
								for(var i = 0; i < msg.data.length; i++) {
									strs += '<tr class="gradeX">' +
										'<td class="centerSort">' + (i + 1) + '</td>' +
										'<td class="center grade_name" name = '+ msg.data[i].class_name +'>' + msg.data[i].grade_name + '</td>' +
										'<td class="center name">' + msg.data[i].name + '</td>' +
										'<td class="center sign_date">' + msg.data[i].sign_date + '</td>' +
										'<td class="center sign">' + msg.data[i].sign + '</td>' +
										'<td class="center late">' + msg.data[i].late + '</td>' +
										'<td class="center early">' + msg.data[i].early + '</td>' +
										'<td><i class="fa fa-calendar areapen" title="查看详情" id = '+ msg.data[i].id +'></td>' +
										'</tr>'
								}
								$("#tbody").html(strs);
							} else {
								$("#tbody").html('<tr><td colspan="8" style="text-align:center;font-size:18px;color:#666;padding:50px;background:#fff;height:318px;">暂无数据！</td></tr>');
							}
						},
						error: function() {
							console.log("error");
						}
					});
				}

				//查询
				$("#searchBtn").click(function() {
					getAjaxData({
						"grade_id": $("#grade-name").val() == '' ? undefined : $("#grade-name").val(),
						"class_id": $("#class-name").val() == '' ? undefined : $("#class-name").val(),
						"date": $("#monthly").val() == '' ? undefined : $("#monthly").val(),
						"student_name": $("#student-name").val() == '' ? undefined : $("#student-name").val(),
						"school_id": school,
						"limit": 20,
						"offset": 1,
					});
				});


				//添加弹框
				$('.areapen').click(function() {console.log($(this).parent().siblings(".sign_date").html());
					$(".studentName").html($(this).parent().siblings(".name").html());
					$(".studentClass").html($(this).parent().siblings(".grade_name").attr("name"));
					$(".studentGrade").html($(this).parent().siblings(".grade_name").html());
					$(".attendanceInfo .attendance").eq(0).find("span").html($(this).parent().siblings(".sign").html());
					$(".attendanceInfo .attendance").eq(1).find("span").html($(this).parent().siblings(".late").html());
					$(".attendanceInfo .attendance").eq(2).find("span").html($(this).parent().siblings(".early").html());
					$(".attendanceInfo .year").html($(this).parent().siblings(".sign_date").html().substring(0,4));
					$(".attendanceInfo .month").html($(this).parent().siblings(".sign_date").html().substring(5));
					var data = {
						"student_id": $(this).attr("id"),
						"start_date": $(".sign_date").html(),
						'end_date': $(".sign_date").html(),
					}
					$.ajax({
						method: 'GET',
						xhrFields: {
							"withCredentials": true
						},
						contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
						url: "/student_sign_details/combination_infos",
						data: data,
						dataType: 'json',
						jsonpCallback: '',
						cache: false,
						timeout: "1000000",
						success: function(msg) {
//							var msg = JSON.parse(msg);
							console.log(msg)
							var calendarData = new Array();
							for(var i=0;i<msg.sign_data.length;i++){
								calendarData[i] = new Object();
								calendarData[i].date = msg.sign_data[i].date;
								calendarData[i].data = msg.sign_data[i].status;
							}
							console.log(calendarData)
							//弹框日历
							$('.calendar-box').calendar({
								ele : '.calendar-layer', 
								title : '',
								data : calendarData
							});
							var length = $(".calendar-box .ht-rili-body .ht-rili-onclick").length;
							for(var i = 0;i < length;i++){
							    if($(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").html() == '10'){
							    	$(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").html("");
							    	$(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").css('background','#a94442');
							    }else if($(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").html() == '20'){
							    	$(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").html("");
							    	$(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").css('background','#bd814b');
							    }else if($(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").html() == '01'){
							    	$(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").html("");
							    	$(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").css('background','#7b500e');
							    }else if($(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").html() == '02'){
							    	$(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").html("");
							    	$(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").css('background','#9a9045');
							    }else if($(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").html() == '12'){
							    	$(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").html("");
							    	$(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").css('background','#729042');
							    }else if($(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").html() == '21'){
							    	$(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").html("");
							    	$(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").css('background','#72d46d');
							    }else if($(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").html() == '22'){
							    	$(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").html("");
							    	$(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").css('background','#405d94');
							    }else if($(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").html() == '11'){
							    	$(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").html("");
							    	$(".calendar-box .ht-rili-body .ht-rili-onclick").eq(i).find(".ht-rili-money").css('background','#1ba0e7');
							    }
							}
							
						},
						complete: function(XMLHttpRequest, status) {

						}
					})
					var layerIndex = layer.open({
						title: '考勤',
						type: 1,
						skin: 'layui-layer-demo',
						closeBtn: 1,
						anim: 2,
						shadeClose: true,
						content: $('#addAttendanceContent'),
						yes: function() {
							
						}
					});
				});

				
			});
		</script>
	</body>

</html>