<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>后端管理</title>
		<meta name="keywords" content="后端管理">
		<meta name="description" content="后端管理">

		<link href="css/bootstrap.min.css" rel="stylesheet">
		<link href="css/font-awesome.min.css" rel="stylesheet">
		<link href="css/animate.min.css" rel="stylesheet">
		<link href="css/style.min.css" rel="stylesheet">
		<link href="css/pager.css" rel="stylesheet" type="text/css" />
		<link href="css/style.css" rel="stylesheet" type="text/css" />
		<link href="js/plugins/layer/skin/default/layer.css" rel="stylesheet" type="text/css" />
		<link href="css/layui.css" media="all" rel="stylesheet">
		<link href="css/daterangepicker.css" media="all" rel="stylesheet">

		<script src="js/jquery.min.js"></script>

	</head>
	<style>
		#class-name {
			width: 180px;
			margin-left: 5px;
		}
		
		.daterangepicker_input {
			display: none;
		}
		
		.data_name{
			color: #278be4;
			cursor: pointer;
		}
	</style>

	<body class="gray-bg">
		<div class="wrapper wrapper-content animated fadeIn">
			<div class="row">
				<div class="col-sm-12">
					<div class="tabs-container">
						<div class="panel-body">
							<div class="wrapper wrapper-content animated fadeInRight">
								<div class="row">
									<div class="col-sm-12">
										<div class="bgBackground">
											<div class="ibox-title-Myown1">
												<div class="zx_searchTit">
													<div class="sendInquiry2" style="float: left;width: 450px;">
														<label class="control-label">所在班级：</label>
														<select id="grade-name">
															<option value="">--请选择年级--</option>
														</select>
														<select id="class-name">
															<option value="">--请选择班级-</option>
														</select>
													</div>
													<div class="sendInquiry2" style="float: left;">
														<label class="control-label">学生姓名：</label>
														<input type="text" name="" value="" id="student-name" />
													</div>
													<div class="sendInquiry2" style="float: left;">
														<label class="control-label">家长姓名：</label>
														<input type="text" name="" value="" id="parent-name" />
													</div>
													<div class="sendInquiry2" style="float: left;">
														<label class="control-label">家长手机：</label>
														<input type="text" name="" value="" id="parent-phone" />
													</div>
													<div class="sendInquiry0 col-sm-4" style="position: relative; margin:3.5px 0 0 0;">
														<button class="btn btn-primary btn-myown" id="searchBtn">查询</button>
													</div>
													<div style="clear: both;"></div>
												</div>
											</div>
											<div class="ibox-content">
												<table class="table table-striped table-bordered table-hover dataTables-example">
													<thead>
														<tr class="zx_checkedAll">
															<th colspan="6" style="text-align: left; background: none;padding: 10px 0px;">
																<button class="btn btn-primary btn-myown" id="addInfo">+添加</button>&nbsp;&nbsp;
																<button class="btn btn-primary btn-myown" id="addManage">批量导入
																</button>
																<input type="file" id="upload" name="upload" style="display:none" />
																<a href="https://www.cloudyl.cn/edu/lib/student_model.xls"><button class="btn btn-primary btn-myown" id="addManageDown">下载导入模板</button></a>
																<a href="https://www.cloudyl.cn/batch_student_excel/combination_infos"><button class="btn btn-primary btn-myown" id="moreManageDown">批量下载</button></a>
															</th>
														</tr>
														<tr class="zx_thTitle">
															<th>学生姓名</th>
															<th>年级</th>
															<th>班级</th>
															<th>关系</th>
															<th>家长姓名</th>
															<th>手机号码</th>
															<th>创建时间</th>
															<th style="width: 120px;">操作</th>
														</tr>
													</thead>
													<tbody id="tbody">

													</tbody>
												</table>
												<div id="layPage"></div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

			</div>
		</div>

		<!--添加内容-->
		<div id="addInfoContent" style="display: none; width: 500px; padding: 20px;">
			<form id="addInfoContentform" role="form" method="POST">
				<div style="margin: 20px 0;">
					<span>学生姓名：</span><input type="text" style="width: 350px;" id="add_name" name="add_name" />
					<div class="errorPart"></div>
				</div>
				<div style="margin: 20px 0;position: relative;margin-left: -4px;">
					<span>出生日期：</span>
					<input type="text" id="add_time" class="form-control" name="add_time" style="width: 350px;display: inline-block;cursor: pointer;" readonly>
					<i class="glyphicon glyphicon-calendar fa fa-calendar" style="position: absolute;right: 20px;top: 8px;pointer-events: none;"></i>
				    <div class="errorPartAddTime errorPartSpt">请选择出生日期</div>
				</div>
				<div style="margin: 20px 0;">
					<span>性别：</span>
					<input type="radio" value="1" name="addsex" checked><span style="width: 40px;margin-left: 5px;">男</span>
					<input type="radio" value="0" name="addsex"><span style="width: 40px;margin-left: 5px;">女</span>
				</div>
				<div style="margin: 20px 0;">
					<span class="fl">备注：</span>
					<textarea style="width: 350px;" id="add_remarks" name="add_remarks"></textarea>
				</div>
				<div style="margin: 20px 0;" class="selectPart">
					<span>所在班级：</span>
					<select style="width: 170px;" id="add_grade" name="add_grade">
						<option value="">--请选择年级--</option>
					</select>
					<select style="width: 170px; margin-left: 6px;" id="add_class" name="add_class">
						<option value="">--请选择班级--</option>
					</select>
					<div class="errorPartAddClass errorPartSpt">请选择班级</div>
				</div>
				<div class="addRelative">
					<div style="margin: 20px 0;" class="addRelativeList">
						<span class="fl">第一联系人：(必填)</span>
						<div class="">
							<select name="add_relative">
								<option value="father">父亲</option>
								<option value="moter">母亲</option>
								<option value="grandfather">爷爷</option>
								<option value="grandmother">奶奶</option>
							</select>
							<input class="relative_name" type="text" name="relative_name" placeholder="姓名"/>
							<div class="errorPart" style="display: inline-block;padding-left: 5px;"></div>
						</div>
						<div>
							<input class="relative_phone" type="text" name="relative_phone" placeholder="手机号码" class="marLeft100 marTop10" style="margin-left: 0px;" id="relative_phone_add"/>
							<div class="errorPart"></div>
						</div>
					</div>
					<div style="margin: 20px 0;" class="addRelativeList">
						<span class="fl">第二联系人：</span>
						<select name="add_relative">
							<option value="father">父亲</option>
							<option value="moter">母亲</option>
							<option value="grandfather">爷爷</option>
							<option value="grandmother">奶奶</option>
						</select>
						<input class="relative_name" type="text" placeholder="姓名" name="relative_name2" />
						<input class="relative_phone" type="text" placeholder="手机号码" class="marLeft100 marTop10" name="relative_phone2" />
						<div class="errorPart"></div>
					</div>
					<div style="margin: 20px 0;" class="addRelativeList">
						<span class="fl">第三联系人：</span>
						<select name="add_relative">
							<option value="father">父亲</option>
							<option value="moter">母亲</option>
							<option value="grandfather">爷爷</option>
							<option value="grandmother">奶奶</option>
						</select>
						<input class="relative_name" type="text" placeholder="姓名" name="relative_name3" />
						<input class="relative_phone" type="text" placeholder="手机号码" class="marLeft100 marTop10" name="relative_phone3" />
						<div class="errorPart"></div>
					</div>
				</div>
				<input class="addRelativeBtn" type="button" value="+" name="addRelativeBtn">
				<input class="submit" type="submit" value="提交" id="addInfoContentSubmit" style="display: none;">
			</form>
		</div>
		<!--编辑内容-->
		<div id="editAreaContent" style="display: none; width: 500px; padding: 20px;">
			<form id="editAreaContentform" role="form">
				<div style="margin: 20px 0;">
					<span>学生姓名：</span><input type="text" style="width: 350px;" id="edit_name" name="edit_name" />
					<div class="errorPart"></div>
				</div>
				<div style="margin: 20px 0;position: relative;margin-left: -4px;">
					<span>出生日期：</span>
					<input type="text" id="edit_time" class="form-control" name= "edit_time" style="width: 350px;display: inline-block;cursor: pointer;" readonly>
					<i class="glyphicon glyphicon-calendar fa fa-calendar" style="position: absolute;right: 20px;top: 8px;pointer-events: none;"></i>
					<div class="errorPartEditTime errorPartSpt">请选择出生日期</div>
				</div>
				<div style="margin: 20px 0;">
					<span>性别：</span>
					<input type="radio" name="editsex" value="1" checked><span style="width: 40px;margin-left: 5px;">男</span>
					<input type="radio" name="editsex" value="0"><span style="width: 40px;margin-left: 5px;">女</span>
				</div>
				<div style="margin: 20px 0;">
					<span class="fl">备注：</span>
					<textarea style="width: 350px;" id="edit_remarks" name="edit_remarks"></textarea>
				</div>
				<div style="margin: 20px 0;" class="selectPart">
					<span>所在班级：</span>
					<select style="width: 170px;" id="edit_grade" name="edit_grade">
						<option value="">--请选择年级--</option>
					</select>
					<select style="width: 170px; margin-left: 6px;" id="edit_class" name="edit_class">
						<option value="">--请选择班级--</option>
					</select>
					<div class="errorPartEditClass errorPartSpt">请选择班级</div>
				</div>
				<div class="editRelative">
					<div style="margin: 20px 0;" class="editRelativeList">
						<span class="fl">第一联系人：(必填)</span>
						<div class="">
							<select name="edit_relative" class="edit_relative">
								<option value="father">父亲</option>
								<option value="moter">母亲</option>
								<option value="grandfather">爷爷</option>
								<option value="grandmother">奶奶</option>
							</select>
							<input class="relative_name" type="text" name="relative_name" placeholder="姓名"/>
							<div class="errorPart" style="display: inline-block;padding-left: 5px;"></div>
						</div>
						<div>
							<input class="relative_phone" type="text" name="relative_phone" placeholder="手机号码" class="marLeft100 marTop10" style="margin-left: 0px;" id="relative_phone_edit"/>
							<div class="errorPart"></div>
						</div>
					</div>
					<div style="margin: 20px 0;" class="editRelativeList">
						<span class="fl">第二联系人：</span>
						<select name="edit_relative" class="edit_relative">
							<option value="father">父亲</option>
							<option value="moter">母亲</option>
							<option value="grandfather">爷爷</option>
							<option value="grandmother">奶奶</option>
						</select>
						<input class="relative_name" type="text" name="edit_relative_name2" placeholder="姓名" />
						<input class="relative_phone" type="text" name="edit_relative_phone2" placeholder="手机号码" class="marLeft100 marTop10" />
					</div>
					<div style="margin: 20px 0;" class="editRelativeList">
						<span class="fl">第三联系人：</span>
						<select name="edit_relative" class="edit_relative">
							<option value="father">父亲</option>
							<option value="moter">母亲</option>
							<option value="grandfather">爷爷</option>
							<option value="grandmother">奶奶</option>
						</select>
						<input class="relative_name" type="text" name="edit_relative_name3" placeholder="姓名" />
						<input class="relative_phone" type="text" name="edit_relative_phone3" placeholder="手机号码" class="marLeft100 marTop10" />
					</div>
				</div>
				<input class="editRelativeBtn" type="button" value="+" name="editRelativeBtn">
				<input class="submit" type="submit" value="提交" id="editAreaContentSubmit" style="display: none;">
			</form>
		</div>

		<script src="js/bootstrap.min.js"></script>
		<script src="js/plugins/layer/layer.js"></script>
		<script src="js/jquery.validate.min.js"></script>
		<script src="js/jquery.form.js"></script>
		<script src="js/layui.js" charset="utf-8"></script>
		<script src="js/moment.js" charset="utf-8"></script>
		<script src="js/daterangepicker.js" charset="utf-8"></script>
		<script src="js/common.js" charset="utf-8"></script>
		v<script src="js/ajaxfileupload.js" charset="utf-8"></script>
		<script type="text/javascript">
			$(document).ready(function() {
				TimeSelectOption($('#add_time'));
				var log_grade_id;
				var log_class_id;
				var log_name;
				var log_relative_name;
				var log_relative_phone;
				//获取学校
				var schoolSelect = JSON.parse(localStorage.getItem("school"));
			    var school = schoolSelect.id;  
			    var cardcode = schoolSelect.cardcode;
				//获取年级
				gradeInput();

				function gradeInput() {
					var data = {
						"limit": 20,
						"offset": 1,
						'school_id': school,
					}
					$.ajax({
						method: 'GET',
						xhrFields: {
							"withCredentials": true
						},
						contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
						url: "/grade/infos",
						data: data,
						dataType: 'json',
						jsonpCallback: '',
						cache: false,
						timeout: "1000000",
						success: function(msg) {
							var str = '<option value="">--请选择年级--</option>';
							var layerSrt = '';
							if(msg.data.length > 0) {
								for(var i = 0; i < msg.data.length; i++) {
									str += '<option value=' + msg.data[i].id + '>' + msg.data[i].name + '</option>';
									layerSrt += '<div class="gradeNameList"><input type="checkbox" name="' + msg.data[i].id +
										'" value="' + msg.data[i].id + '" /><span class="gradeName">' + msg.data[i].name + '</span></div>'
								}
								$("#grade-name").html(str);
								$("#add_grade").html(str);
								$("#edit_grade").html(str);

								$(".gradeNamePart").append(layerSrt);

							} else {
								$("#grade-name").html('<option value="">---无---</option>');
								$("#add_grade").html('<option value="">---无---</option>');
								$("#edit_grade").html('<option value="">---无---</option>');

							}
						},
						complete: function(XMLHttpRequest, status) {

						}
					})

				}
                //批量上传
                $("#addManage").click(function(e){
                	$("#upload").click();
                	e.preventDefault();
                	var param={"school_id":school};
                	var uploadId={"fileElementId":"upload","data":param};
                	console.log(uploadId.data)
                	ajaxFileUpload(uploadId);
                });
                function ajaxFileUpload(DOMId){
				    var param={"school_id":school};
				    $.ajaxFileUpload({
				        url:'/batch_student_excel/combination_input',
				        type:'post',
				        secureuri: false,
				        fileElementId: DOMId.fileElementId,
				        dataType:'text/plain',
				        data:DOMId.data,
				        success: function(data, status){  
				        	// top.location.reload();
				        	console.log("1221");
				        },
				        error: function(data, status, e){
				            alert('上传失败');
				        }
				    });
				}
				//切换年级
				$("#grade-name").change(function() {
                    if($("#grade-name").val() == ''||undefined){
						$("#class-name").html('<option value="">---请选择班级---</option>');
					}else{
						classInput({
							"limit": 20,
							"offset": 1,
							'school_id': school,
							"grade_id": $("#grade-name").val() == '' ? undefined : $("#grade-name").val(),
						}, "no");
					}
				});

				//新增弹框切换年级
				$("#add_grade").change(function() {
					if($("#add_grade").val() == ''||undefined){
						$("#add_class").html('<option value="">---请选择班级---</option>');
					}else{
						classInput({
							"limit": 20,
							"offset": 1,
							'school_id': school,
							"grade_id": $("#add_grade").val() == '' ? undefined : $("#add_grade").val(),
						}, "yes", 'yes');
					}
				});

				//编辑弹框切换年级
				$("#edit_grade").change(function() {
					if($("#edit_grade").val() == ''||undefined){
						$("#edit_class").html('<option value="">---请选择班级---</option>');
					}else{
						classInput({
							"limit": 20,
							"offset": 1,
							'school_id': school,
							"grade_id": $("#edit_grade").val() == '' ? undefined : $("#edit_grade").val(),
						}, "yes", 'no');
					}
				});

				//获取班级
				function classInput(data, ifLayer, ifadd) {
					$.ajax({
						method: 'GET',
						xhrFields: {
							"withCredentials": true
						},
						contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
						url: "/class/infos",
						data: data,
						dataType: 'json',
						jsonpCallback: '',
						cache: false,
						timeout: "1000000",
						success: function(msg) {
							var str = '';
							var layerSrt = '';
							if(msg.data.length > 0) {
								for(var i = 0; i < msg.data.length; i++) {
									str += '<option value=' + msg.data[i].id + '>' + msg.data[i].name + '</option>';
								}
								if(ifLayer == "yes") {
									if(ifadd == "yes") {
										$("#add_class").html(str);
									}else{
										$("#edit_class").html(str);
									}
								} else {
									$("#class-name").html(str);
								}
							} else {
								if(ifLayer == "yes") {
									if(ifadd == "yes") {
										$("#add_class").html('<option value="">---无---</option>');
									}else{
										$("#edit_class").html('<option value="">---无---</option>');
									}
								} else {
									$("#class-name").html('<option value="">---无---</option>');
								}
							}
						},
						complete: function(XMLHttpRequest, status) {

						}
					})

				}
                
                if(localStorage.getItem("studentHistory")){
					var dateHistoryLog = JSON.parse(localStorage.getItem("studentHistory"));
					log_grade_id = dateHistory.grade_id;
					log_class_id = dateHistory.class_id;
					log_name = dateHistory.name;
					log_relative_name = dateHistory.relative_name;
					log_relative_phone = dateHistory.relative_phone;
					log_offset = dateHistory.offset;
					//获取列表
					getAjaxData({
						"school_id": school,
						"class_id": log_class_id == '' ? undefined : log_class_id,
						"grade_id": log_grade_id == '' ? undefined : log_grade_id,
						"name": log_name == '' ? undefined : log_name,
						"relative_name": log_relative_name == '' ? undefined : log_relative_name,
						"relative_phone": log_relative_phone == '' ? undefined : log_relative_phone,
						"limit": 20,
						"offset": log_offset,
					});
					localStorage.removeItem('studentHistory');
				}else{
					//获取列表
					getAjaxData({
						"school_id": school,
						"class_id": $("#class-name").val() == '' ? undefined : $("#class-name").val(),
						"grade_id": $("#grade-name").val() == '' ? undefined : $("#grade-name").val(),
						"name": $("#student-name").val() == '' ? undefined : $("#student-name").val(),
						"relative_name": $("#parent-name").val() == '' ? undefined : $("#parent-name").val(),
						"relative_phone": $("#parent-phone").val() == '' ? undefined : $("#parent-phone").val(),
						"limit": 20,
						"offset": 1,
					});
				}

				function getAjaxData(senddata) {
					$.ajax({
						type: "GET",
						contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
						url: "/student/infos",
						async: false,
						data: senddata,
						timeout: "30000",
						success: function(msg) {
							var msg = JSON.parse(msg);console.log(msg)
							//分页
							layui.use(['laypage', 'layer'], function() {
									var page = layui.laypage;
									page.render({
										elem: "layPage",
										count: msg.count,
										curr: senddata.offset,
										limit: senddata.limit,
										layout: ['count', 'prev', 'page', 'next', 'limit', 'skip'],
										jump: function(e, first) {
											if(!first) {
												senddata.offset = e.curr;
												senddata.limit = e.limit;
												var district = "";
												getAjaxData({
													"school_id": school,
													"class_id": $("#class-name").val() == '' ? undefined : $("#class-name").val(),
													"grade_id": $("#grade-name").val() == '' ? undefined : $("#grade-name").val(),
													"student_name": $("#student-name").val() == '' ? undefined : $("#student-name").val(),
													"parent_name": $("#parent-name").val() == '' ? undefined : $("#parent-name").val(),
													"parent_phone": $("#parent-phone").val() == '' ? undefined : $("#parent-phone").val(),
													"limit": e.limit,
													"offset": e.curr,
												});
											}
										}
									})
								})
								//表格渲染
							var strs = '';
							if(msg.data.length > 0) {
								for(var i = 0; i < msg.data.length; i++) {
									var relation = ''
									if(msg.data[i].relation_list[0].relation == "father"){
                                        relation = "父亲"
									}else if(msg.data[i].relation_list[0].relation == "moter"){
										 relation = "母亲"
									}else if(msg.data[i].relation_list[0].relation == "grandfather"){
										 relation = "爷爷"
									}else if(msg.data[i].relation_list[0].relation == "grandmother"){
										 relation = "奶奶"
									}else{
										relation = "暂无"
									}
									strs += '<tr class="gradeX">' +
										'<td class="data_name" title = '+ msg.data[i].id +'>' + msg.data[i].name + '</td>' +
										'<td>' + msg.data[i].grade_name + '</td>' +
										'<td>' + msg.data[i].class_name + '</td>' +
										'<td class="center data_id">' + relation + '</td>' +
										'<td class="center">' + msg.data[i].relation_list[0].relation_info.name + '</td>' +
										'<td class="center">' + msg.data[i].relation_list[0].relation_info.phone + '</td>' +
										'<td class="center">' + msg.data[i].create_time + '</td>' +
										'<td><i class="fa fa-pencil areapen" name=' + msg.data[i].id + ' title="修改"></i>&nbsp;&nbsp;<i class="fa fa-close" id=' + msg.data[i].id + ' title="删除"></i></td>' +
										'</tr>'
								}
								$("#tbody").html(strs);
							} else {
								$("#tbody").html('<tr><td colspan="8" style="text-align:center;font-size:18px;color:#666;padding:50px;background:#fff;height:318px;">暂无数据！</td></tr>');
							}
							//学生历史
							$(".data_name").click(function(){
								if(localStorage.getItem("studentHistory")){
									var dateHistory = JSON.parse(localStorage.getItem("studentHistory"));
									dateHistory.id = $(this).attr("title");
									dateHistory.grade_id = $("#grade-name").val();
									dateHistory.class_id = $("#class-name").val();
									dateHistory.name = $("#student-name").val();
									dateHistory.relative_name = $("#parent-name").val();
									dateHistory.relative_phone = $("#parent-phone").val();
									dateHistory.offset = $(".layui-input").val();
									window.localStorage.setItem("studentHistory", JSON.stringify(dateHistory));
								}else{
									var dateHistory = new Object();
									dateHistory.id = $(this).attr("title");
									dateHistory.grade_id = $("#grade-name").val();
									dateHistory.class_id = $("#class-name").val();
									dateHistory.name = $("#student-name").val();
									dateHistory.relative_name = $("#parent-name").val();
									dateHistory.relative_phone = $("#parent-phone").val();
									dateHistory.offset = $(".layui-input").val();
									window.localStorage.setItem("studentHistory", JSON.stringify(dateHistory));
								}
								top.location.href = "index.html#studentHistory.html";
								top.location.reload();
							});
						},
						error: function() {
							console.log("error");
						}
					});
				}

				//查询
				$("#searchBtn").click(function() {
					if($("#class-name").val() == '--请选择班级--' || $("#class-name").val() == '---无---') {
						$("#class-name").val() = '';
					}
					if($("#grade-name").val() == '--请选择年级--' || $("#grade-name").val() == '---无---') {
						$("#grade-name").val() = '';
					}
					getAjaxData({
						"school_id": school,
						"class_id": $("#class-name").val() == '' ? undefined : $("#class-name").val(),
						"grade_id": $("#grade-name").val() == '' ? undefined : $("#grade-name").val(),
						"name": $("#student-name").val() == '' ? undefined : $("#student-name").val(),
						"relative_name": $("#parent-name").val() == '' ? undefined : $("#parent-name").val(),
						"relative_phone": $("#parent-phone").val() == '' ? undefined : $("#parent-phone").val(),
						"limit": 20,
						"offset": 1,
					});
				});

				var relativeStr = '<div style="margin: 20px 0;" class="addRelativeList">' +
					'<span class="fl">其他联系人：</span>' +
					'<select name="add_relative" class="add_relative">' +
					'<option value="father">父亲</option>' +
					'<option value="moter">母亲</option>' +
					'<option value="grandfather">爷爷</option>' +
					'<option value="grandmother">奶奶</option>' +
					'</select>' +
					'<input class="relative_name" type="text" placeholder="姓名" name="add_relative_name_other"/>' +
					'<input class="relative_phone" type="text" placeholder="手机号码" class="marLeft100 marTop10" name="edit_relative_phone_other"/>' +
					'<div class="errorPart"></div>' +
					'</div>';
               var relativeStrEdit= '<div style="margin: 20px 0;" class="editRelativeList">' +
					'<span class="fl">其他联系人：</span>' +
					'<select name="edit_relative" class="edit_relative">' +
					'<option value="father">父亲</option>' +
					'<option value="moter">母亲</option>' +
					'<option value="grandfather">爷爷</option>' +
					'<option value="grandmother">奶奶</option>' +
					'</select>' +
					'<input class="relative_name" type="text" placeholder="姓名" name="edit_relative_name_other"/>' +
					'<input class="relative_phone" type="text" placeholder="手机号码" class="marLeft100 marTop10" name="edit_relative_phone_other"/>' +
					'<div class="errorPart"></div>' +
					'</div>';

				$(".addRelativeBtn").click(function() {
					$(".addRelative").append(relativeStr);
				});
				$(".editRelativeBtn").click(function() {
					$(".editRelative").append(relativeStrEdit);
				});
				//校验隐藏
				$("#add_grade").change(function() {
					$(".errorPartAddClass").css("display", "none");
				});
				$("#add_time").focus(function() {
					$(".errorPartAddTime").css("display", "none");
				});
				//添加校验
				var layerIndex;

				$("#add_grade").click(function() {
					$(".selectPart .errorPartS").css("display", "none");
				});

				jQuery.validator.addMethod("isPhone", function(value, element) {
					var reg = /^[1][3,4,5,7,8][0-9]{9}$/;
					var phoneNum = $("#relative_phone_add").val();
					var flag = reg.test(phoneNum);
					return flag;
				}, "请正确填写手机号码");
                
                jQuery.validator.addMethod("isPhoneEdit", function(value, element) {
					var reg = /^[1][3,4,5,7,8][0-9]{9}$/;
					var phoneNum = $("#relative_phone_edit").val();
					var flag = reg.test(phoneNum);
					return flag;
				}, "请正确填写手机号码");
				$("#addInfoContentform").validate({
					focusCleanup: true,
					focusInvalid: false,
					debug: true,
					rules: {
							add_name: {
								required: true,
							},
							relative_name: {
								required: true,
							},
							relative_phone: {
								required: true,
								isPhone: true,
							}
					},
					messages: {
							add_name: {
								required: '必填',
							},
							relative_name: {
								required: '必填',
							},
							relative_phone: {
								required: '必填',
								isPhone: '请正确填写手机号码',
							}
					},
					submitHandler: function(form) {
						if($("#add_class").val() == '' || $("#add_class").val() == undefined) {
							$(".errorPartAddClass").css("display", "block");
							if($("#add_time").val() == '' || $("#add_time").val() == undefined) {
								$(".errorPartAddTime").css("display", "block");
								return false;
							}
							return false;
						}

						var addRelativeLength = $(".addRelative .addRelativeList").length;
						var relative_list = new Array();
						for(var i = 0; i < addRelativeLength; i++) {
							relative_list[i] = new Object();
							relative_list[i].name = $(".addRelative .addRelativeList").eq(i).find(".relative_name").val();
							relative_list[i].phone = $(".addRelative .addRelativeList").eq(i).find(".relative_phone").val();
							relative_list[i].relation = $(".addRelative .addRelativeList").eq(i).find("select option:selected").val();
						}
						for(var j = 0; j < addRelativeLength; j++) {
							if(relative_list[j].name == '' || relative_list[j].phone == '') {
								relative_list[j] = '';
							}
						}
                        for(var j = 0; j < addRelativeLength; j++) {
                        	var c = $.inArray('',relative_list);
                        	if(c != -1){
                        		relative_list.splice(c,1);
                        	}
                        }
                        
						var data = {
							'name': $("#add_name").val(),
							'birthday': $("#add_time").val(),
							'sex': $("input[name='addsex']:checked").val(),
							'class_id': $("#add_class").val(),
							'describe': $("#add_remarks").val(),
							'relative_list': JSON.stringify(relative_list),
						}
						$.ajax({
							type: "POST",
							contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
							url: "/student_relative/combination_input",
							async: false,
							data: data,
							timeout: "30000",
							success: function(msg) {
								layer.closeAll();
								layer.msg('添加成功', {
									icon: 1,
									time: 800
								});
								window.location.reload();
							},
							error: function() {
								layer.msg('添加失败');
								console.log("error");
							}
						});

					},
					errorPlacement: function(error, element) {
						error.appendTo(element.parent().find(".errorPart"));
					},
					success: function() {}
				});

				//添加弹框
				$('#addInfo').click(function() {
					$("input[type='text']").val("");
					$(".errorPart").html("");
					$("#add_grade").html('<option value="">--请选择年级--</option>');
					$("#add_class").html('<option value="">--请选择班级--</option>');
					$(".errorPartSpt").css("display", "none");
					gradeInput();
					layerIndex = layer.open({
						title: '添加学生',
						type: 1,
						skin: 'layui-layer-demo',
						anim: 2,
						shadeClose: true,
						btn: ['确定', '取消'],
						content: $('#addInfoContent'),
						yes: function() {
							$("#addInfoContentSubmit").click();
							if($("#add_class").val() == '' || $("#add_class").val() == undefined) {
								$(".errorPartAddClass").css("display", "block");
							}
							if($("#add_time").val() == '' || $("#add_time").val() == undefined) {
								$(".errorPartAddTime").css("display", "block");
							}
						}
					});
				});

				//编辑校验
				$("#editAreaContentform").validate({
					focusCleanup: true,
					focusInvalid: false,
					debug: true,
					rules: {
						edit_name: {
							required: true,
						},
						relative_name: {
							required: true,
						},
						relative_phone: {
							required: true,
							isPhoneEdit: true,
						}
					},
					messages: {
						edit_name: {
							required: '必填',
						},
						relative_name: {
							required: '必填',
						},
						relative_phone: {
							required: '必填',
							isPhoneEdit: '请正确填写手机号码',
						}
					},
					submitHandler: function(form) {
						if($("#edit_class").val() == '' || $("#edit_class").val() == undefined) {
							$(".errorPartEditClass").css("display", "block");
							if($("#edit_time").val() == '' || $("#edit_time").val() == undefined) {
								$(".errorPartEditTime").css("display", "block");console.log(时间我空)
								return false;
							}
							return false;
						}
						
						var data = {
							'name':$("#edit_name").val(),
							'id': $("#edit_name").attr("title"),
							'sex': $("input[name='editsex']:checked").val(),
							'birthday': $("#edit_time").val(),
							'describe': $("#edit_remarks").val(),
						}
						console.log($("input[name='editsex']:checked").val())
						$.ajax({
							type: "POST",
							contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
							url: "/student/update",
							async: false,
							data: data,
							timeout: "30000",
							success: function(msg) {
								
								var editRelativeLength = $(".editRelative .editRelativeList").length;
								var relative_list = new Array();
								for(var i = 0; i < editRelativeLength; i++) {
									relative_list[i] = new Object();
									relative_list[i].id = $(".editRelative .editRelativeList").eq(i).find(".edit_relative").attr("id");
									relative_list[i].name = $(".editRelative .editRelativeList").eq(i).find(".relative_name").val();
									relative_list[i].phone = $(".editRelative .editRelativeList").eq(i).find(".relative_phone").val();
									relative_list[i].relation = $(".editRelative .editRelativeList").eq(i).find("select option:selected").val();
								}
								for(var i = 0; i < editRelativeLength; i++) {
									if(relative_list[i].name == '' || relative_list[i].phone == '') {
										relative_list[i] = '';
									}
								}
								for(var j = 0; j < editRelativeLength; j++) {
		                            var c = $.inArray('',relative_list);
		                        	if(c != -1){
		                        		relative_list.splice(c,1);
		                        	}
		                        }
                                
								var relativeData = {
										'student_id': $("#edit_name").attr("title"),
										'relative_list': JSON.stringify(relative_list),
									}
								$.ajax({
									type: "POST",
									contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
									url: "/bath_update_relative/combination_input",
									async: false,
									data: relativeData,
									timeout: "30000",
									success: function(msg) {
										layer.closeAll();
										layer.msg('编辑成功', {
											icon: 1,
											time: 800
										});
										window.location.reload();
									},
									error: function() {
										layer.msg('编辑失败');
										console.log("error");
									}
								});
									},
									error: function() {
										layer.msg('编辑失败');
										console.log("error");
									}
								});
					},

					errorPlacement: function(error, element) {
						error.appendTo(element.parent().find(".errorPart"));
					},
					success: function() {}
				});

				//编辑弹框
				$('.areapen').click(function() {
					$("input[type = 'text']").val("");
					$(".editRelativeBtn").val("+");
					$(".errorPart").html("");
					$(".errorPartSpt").css("display","none")
					$(".selectPart .errorPartS").css("display", "none");
					layerIndex = layer.open({
						title: '修改学生信息',
						type: 1,
						skin: 'layui-layer-demo',
						closeBtn: 0,
						anim: 2,
						shadeClose: true,
						btn: ['确定', '取消'],
						content: $('#editAreaContent'),
						yes: function() {
							$("#editAreaContentSubmit").click();
							if($("#edit_class").val() == '' || $("#edit_class").val() == undefined) {
								$(".errorPartEditClass").css("display", "block");
							}
							if($("#edit_time").val() == '' || $("#edit_time").val() == undefined) {
								$(".errorPartEditTime").css("display", "block");
							}
						}
					});
					var editData = {
						"school_id": school,
						"id": $(this).attr("name"),
						"limit": 20,
						"offset": 1,
					};
					$.ajax({
						type: "GET",
						contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
						url: "/student/infos",
						async: false,
						data: editData,
						timeout: "30000",
						success: function(msg) {
							var msg = JSON.parse(msg);console.log(msg);
							$("#edit_name").val(msg.data[0].name);
							$("#edit_name").attr("title",msg.data[0].id);
							TimeSelectOption($('#edit_time'), msg.data[0].birthday);
							$("input[name='editsex'][value='" + msg.data[0].sex + "']").prop("checked", "checked");
							$("#edit_remarks").val(msg.data[0].describe);
							$("#edit_grade").val(msg.data[0].grade_id);
							$("#edit_grade").change();
							$("#edit_class").val(msg.data[0].class_id);
							for(var i = 0; i < msg.data[0].relation_list.length; i++) {
								if(i < 3) {
									$(".editRelative .editRelativeList").eq(i).find(".edit_relative").val(msg.data[0].relation_list[i].relation);
									$(".editRelative .editRelativeList").eq(i).find(".edit_relative").attr("id",msg.data[0].relation_list[i].relative_id);
									$(".editRelative .editRelativeList").eq(i).find(".relative_name").val(msg.data[0].relation_list[i].relation_info.name);
									$(".editRelative .editRelativeList").eq(i).find(".relative_phone").val(msg.data[0].relation_list[i].relation_info.phone);
								}else{
									$(".editRelativeBtn").click();
									$(".editRelative .editRelativeList").eq(i).find(".edit_relative").val(msg.data[0].relation_list[i].relation);
									$(".editRelative .editRelativeList").eq(i).find(".edit_relative").attr("id",msg.data[0].relation_list[i].relative_id);
									$(".editRelative .editRelativeList").eq(i).find(".relative_name").val(msg.data[0].relation_list[i].relation_info.name);
									$(".editRelative .editRelativeList").eq(i).find(".relative_phone").val(msg.data[0].relation_list[i].relation_info.phone);
								}

							}
						},
						error: function() {}
					});
				});

				//删除
				$('#tbody .fa-close').click(function() {
					var deleteId = $(this).attr('id');
					layer.confirm('确定删除选中的学生？', {
						btn: ['确定', '取消']
					}, function() {
						var data = {
							'student_id': deleteId
						}
						$.ajax({
							type: "POST",
							contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
							url: "/delete_student_relative/combination_input",
							async: false,
							data: data,
							timeout: "30000",
							success: function(msg) {
								layer.closeAll();
								layer.msg('删除成功', {
									icon: 1,
									time: 800 //2s后自动关闭
								});
								window.location.reload();
							},
							error: function() {
								layer.msg('删除失败');
								console.log("error");
							}
						});
					});
				});

				//添加弹框日期
				var beginTimeTake;

				function TimeSelectOption(reportrangeId, time) {
					console.log(time)
					if(time != '' && time != undefined && time != null && time != 'null' ) {
						reportrangeId.val(time);
					} else {
						time = moment().format('YYYY-MM-DD');
					}
					reportrangeId.daterangepicker({
						startDate: time,
						singleDatePicker: true,
						showDropdowns: true,
						autoUpdateInput: false,
						timePicker24Hour: true,
						timePicker: true,
						"locale": {
							format: 'YYYY-MM-DD',
							applyLabel: "确定",
							cancelLabel: "取消",
							resetLabel: "重置",
						}
					}, function(start, end, label) { //格式化日期显示框
						beginTimeTake = start;
						if(!this.startDate) {
							this.element.val('');
						} else {
							this.element.val(this.startDate.format(this.locale.format));
						}
					});
				};
			});
		</script>
	</body>

</html>