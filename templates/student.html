<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>后端管理</title>
		<meta name="keywords" content="后端管理">
		<meta name="description" content="后端管理">

		<link href="css/bootstrap.min.css" rel="stylesheet">
		<link href="css/font-awesome.min.css" rel="stylesheet">
		<link href="css/animate.min.css" rel="stylesheet">
		<link href="css/style.min.css" rel="stylesheet">
		<link href="css/pager.css" rel="stylesheet" type="text/css" />
		<link href="css/style.css" rel="stylesheet" type="text/css" />
		<link href="js/plugins/layer/skin/default/layer.css" rel="stylesheet" type="text/css" />
		<link href="css/layui.css" media="all" rel="stylesheet">
		<link href="css/daterangepicker.css" media="all" rel="stylesheet">

		<script src="js/jquery.min.js"></script>

	</head>
   <style>
   	#class-name{
   		width: 180px;
   		margin-left: 5px;
   	}
   </style>
	<body class="gray-bg">
		<div class="wrapper wrapper-content animated fadeIn">
			<div class="row">
				<div class="col-sm-12">
					<div class="tabs-container">
						<div class="panel-body">
							<div class="wrapper wrapper-content animated fadeInRight">
								<div class="row">
									<div class="col-sm-12">
										<div class="bgBackground">
											<div class="ibox-title-Myown1">
												<div class="zx_searchTit">
													<div class="sendInquiry2" style="float: left;width: 450px;">
														<label class="control-label">所在班级：</label>
														<select id="grade-name">
															<option value="">--请选择年级--</option>
														</select>
														<select id="class-name">
															<option value="">--请选择班级-</option>
														</select>
													</div>
													<div class="sendInquiry2" style="float: left;">
														<label class="control-label">学生姓名：</label>
														<input type="text" name="" value="" id="student-name" />
													</div>
													<div class="sendInquiry2" style="float: left;">
														<label class="control-label">家长姓名：</label>
														<input type="text" name="" value="" id="parent-name" />
													</div>
													<div class="sendInquiry2" style="float: left;">
														<label class="control-label">家长手机：</label>
														<input type="text" name="" value="" id="parent-phone" />
													</div>
													<div class="sendInquiry0 col-sm-4" style="position: relative; margin:3.5px 0 0 0;">
														<button class="btn btn-primary btn-myown" id="searchBtn">查询</button>
													</div>
													<div style="clear: both;"></div>
												</div>
											</div>
											<div class="ibox-content">
												<table class="table table-striped table-bordered table-hover dataTables-example">
													<thead>
														<tr class="zx_checkedAll">
															<th colspan="6" style="text-align: left; background: none;padding: 10px 0px;">
																<button class="btn btn-primary btn-myown" id="addInfo">+添加</button>&nbsp;&nbsp;
															</th>
														</tr>
														<tr class="zx_thTitle">
															<th>学生姓名</th>
															<th>关系</th>
															<th>家长姓名</th>
															<th>手机号码</th>
															<th style="width: 120px;">操作</th>
														</tr>
													</thead>
													<tbody id="tbody">

													</tbody>
												</table>
												<div id="layPage"></div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

			</div>
		</div>

		<!--添加内容-->
		<div id="addInfoContent" style="display: none; width: 500px; padding: 20px;">
			<form id="addInfoContentform" role="form" method="POST">
				<div style="margin: 20px 0;">
					<span>学生姓名：</span><input type="text" style="width: 350px;" id="add_name" name="add_name" />
					<div class="errorPart"></div>
				</div>
				<div style="margin: 20px 0;">
					<span>出生日期：</span><input type="text" style="width: 350px;" id="add_bTime" name="add_bTime" />
				</div>
				<div style="margin: 20px 0;">
					<span>性别：</span>
					<input type="radio" name="sex"/><span style="width: 40px;margin-left: 5px;">男</span>
					<input type="radio" name="sex"/><span style="width: 40px;margin-left: 5px;">女</span>
				</div>
				<div style="margin: 20px 0;">
					<span class="fl">备注：</span>
					<textarea style="width: 350px;" id="add_remarks" name="add_remarks"></textarea>
				</div>
				<div style="margin: 20px 0;" class="selectPart">
					<span>所在班级：</span>
					<select style="width: 170px;" id="add_grade" name="add_grade">
						<option value="">--请选择年级--</option>
					</select>
					<select style="width: 170px; margin-left: 6px;" id="add_class" name="add_class">
						<option value="">--请选择班级--</option>
					</select>
				</div>
				<div style="margin: 20px 0;">
					<span class="fl">第一联系人：</span>
					<select>
						<option>父亲</option>
						<option>母亲</option>
						<option>爷爷</option>
						<option>奶奶</option>
					</select>
					<input id="relative_name1" type="text" name="relative_name1" placeholder="姓名"/>
					<input id="relative_phone1" type="text" name="relative_phone1" placeholder="手机号码" class="marLeft100 marTop10"/>
					<div class="errorPart"></div>
				</div>
				<div style="margin: 20px 0;">
					<span class="fl">第一联系人：</span>
					<select>
						<option>父亲</option>
						<option>母亲</option>
						<option>爷爷</option>
						<option>奶奶</option>
					</select>
					<input id="relative_name2" type="text" name="relative_name2" placeholder="姓名"/>
					<input id="relative_phone2" type="text" name="relative_phone2" placeholder="手机号码" class="marLeft100 marTop10"/>
					<div class="errorPart"></div>
				</div>
				<div style="margin: 20px 0;">
					<span class="fl">第三联系人：</span>
					<select>
						<option>父亲</option>
						<option>母亲</option>
						<option>爷爷</option>
						<option>奶奶</option>
					</select>
					<input id="relative_name3" type="text" name="relative_name3" placeholder="姓名"/>
					<input id="relative_phone3" type="text" name="relative_phone3" placeholder="手机号码" class="marLeft100 marTop10"/>
					<div class="errorPart"></div>
				</div>
				<input class="submit" type="submit" value="提交" id="addInfoContentSubmit" style="display: none;">
			</form>
		</div>
		<!--编辑内容-->
		<div id="editAreaContent" style="display: none; width: 500px; padding: 20px;">
			<form id="editAreaContentform" role="form">
				<div style="margin: 20px 0;">
					<span>学生姓名：</span><input type="text" style="width: 350px;" id="edit_name" name="edit_name" />
					<div class="errorPart"></div>
				</div>
				<div style="margin: 20px 0;">
					<span>出生日期：</span>
					<div id="reportrange" style="width: 350px;">
						<i class="icon icon-calendar"></i>
						<span id="searchDeteRange"></span>
						<b class="caret"></b>
					</div>
				</div>
				<div style="margin: 20px 0;">
					<span>性别：</span>
					<input type="radio" name="editsex"/><span style="width: 40px;margin-left: 5px;">男</span>
					<input type="radio" name="editsex"/><span style="width: 40px;margin-left: 5px;">女</span>
				</div>
				<div style="margin: 20px 0;">
					<span class="fl">备注：</span>
					<textarea style="width: 350px;" id="edit_remarks" name="edit_remarks"></textarea>
				</div>
				<div style="margin: 20px 0;" class="selectPart">
					<span>所在班级：</span>
					<select style="width: 170px;" id="edit_grade" name="edit_grade">
						<option value="">--请选择年级--</option>
					</select>
					<select style="width: 170px; margin-left: 6px;" id="edit_class" name="edit_class">
						<option value="">--请选择班级--</option>
					</select>
				</div>
				<div style="margin: 20px 0;">
					<span class="fl">第一联系人：</span>
					<select>
						<option>父亲</option>
						<option>母亲</option>
						<option>爷爷</option>
						<option>奶奶</option>
					</select>
					<input id="edit_relative_name1" type="text" name="edit_relative_name1" placeholder="姓名"/>
					<input id="edit_relative_phone1" type="text" name="edit_relative_phone1" placeholder="手机号码" class="marLeft100 marTop10"/>
					<div class="errorPart"></div>
				</div>
				<div style="margin: 20px 0;">
					<span class="fl">第一联系人：</span>
					<select>
						<option>父亲</option>
						<option>母亲</option>
						<option>爷爷</option>
						<option>奶奶</option>
					</select>
					<input id="edit_relative_name2" type="text" name="edit_relative_name2" placeholder="姓名"/>
					<input id="edit_relative_phone2" type="text" name="edit_relative_phone2" placeholder="手机号码" class="marLeft100 marTop10"/>
					<div class="errorPart"></div>
				</div>
				<div style="margin: 20px 0;">
					<span class="fl">第三联系人：</span>
					<select>
						<option>父亲</option>
						<option>母亲</option>
						<option>爷爷</option>
						<option>奶奶</option>
					</select>
					<input id="edit_relative_name3" type="text" name="edit_relative_name3" placeholder="姓名"/>
					<input id="edit_relative_phone3" type="text" name="edit_relative_phone3" placeholder="手机号码" class="marLeft100 marTop10"/>
					<div class="errorPart"></div>
				</div>
				<input class="submit" type="submit" value="提交" id="editAreaContentSubmit" style="display: none;">
			</form>
		</div>
		
		<script src="js/bootstrap.min.js"></script>
		<script src="js/plugins/layer/layer.js"></script>
		<script src="js/jquery.validate.min.js"></script>
		<script src="js/jquery.form.js"></script>
		<script src="js/layui.js" charset="utf-8"></script>
		<script src="js/moment.js" charset="utf-8"></script>
		<script src="js/daterangepicker.js" charset="utf-8"></script>
		<script src="js/common.js" charset="utf-8"></script>
		<script type="text/javascript">
			$(document).ready(function() {
				TimeSelectOption($('#searchDateRange'), $('#reportrange'));
				//获取学校
				schoolInput();
				//获取年级
				gradeInput();

				function gradeInput() {
					var data = {
						"limit": 20,
						"offset": 1,
						'school_id': school,
					}
					$.ajax({
						method: 'GET',
						xhrFields: {
							"withCredentials": true
						},
						contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
						url: "/grade/infos",
						data: data,
						dataType: 'json',
						jsonpCallback: '',
						cache: false,
						timeout: "1000000",
						success: function(msg) {
							var str = '';
							var layerSrt = '';
							if(msg.data.length > 0) {
								for(var i = 0; i < msg.data.length; i++) {
									str += '<option value=' + msg.data[i].id + '>' + msg.data[i].name + '</option>';
									layerSrt += '<div class="gradeNameList"><input type="checkbox" name="' + msg.data[i].id +
										'" value="' + msg.data[i].id + '" /><span class="gradeName">' + msg.data[i].name + '</span></div>'
								}
								$("#grade-name").append(str);
								$("#add_grade").append(str);
								$("#edit_grade").html(str);

								$(".gradeNamePart").append(layerSrt);

							} else {
								$("#grade-name").html('<option value="">---无---</option>');
								$("#add_grade").html('<option value="">---无---</option>');
								$("#edit_grade").html('<option value="">---无---</option>');

							}
						},
						complete: function(XMLHttpRequest, status) {

						}
					})

				}
				
				//切换年级
				$("#grade-name").change(function(){
					classInput();
				});
                //获取班级
                function classInput() {
					var data = {
						"limit": 20,
						"offset": 1,
						'school_id': school,
						"grade_id": $("#grade-name").val() == '' ? undefined : $("#grade-name").val(),
					}
					$.ajax({
						method: 'GET',
						xhrFields: {
							"withCredentials": true
						},
						contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
						url: "/class/infos",
						data: data,
						dataType: 'json',
						jsonpCallback: '',
						cache: false,
						timeout: "1000000",
						success: function(msg) {
							var str = '';
							var layerSrt = '';
							if(msg.data.length > 0) {
								for(var i = 0; i < msg.data.length; i++) {
									str += '<option value=' + msg.data[i].id + '>' + msg.data[i].name + '</option>';
								}
								$("#class-name").html(str);
								$("#add_class").html(str);
								$("#edit_class").html(str);

							} else {
								$("#class-name").html('<option value="">---无---</option>');
								$("#add_class").html('<option value="">---无---</option>');
								$("#edit_class").html('<option value="">---无---</option>');

							}
						},
						complete: function(XMLHttpRequest, status) {

						}
					})

				}
				//获取列表
//				getAjaxData({
//					"school_id": school,
//					"limit": 20,
//					"offset": 1,
//				});

				function getAjaxData(senddata) {
					$.ajax({
						type: "GET",
						contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
						url: "/relation/infos",
						async: false,
						data: senddata,
						timeout: "30000",
						success: function(msg) {console.log(msg);
							var msg = JSON.parse(msg);console.log(msg);
							//分页
							layui.use(['laypage', 'layer'], function() {
									var page = layui.laypage;
									page.render({
										elem: "layPage",
										count: msg.count,
										curr: senddata.offset,
										limit: senddata.limit,
										layout: ['count', 'prev', 'page', 'next', 'limit', 'skip'],
										jump: function(e, first) {
											if(!first) {
												senddata.offset = e.curr;
												senddata.limit = e.limit;
												var district = "";
												getAjaxData({
													"name": $("#class-name").val() == '' ? undefined : $("#class-name").val(),
													"grade_id": $("#grade-name").val() == '' ? undefined : $("#grade-name").val(),
													"limit": e.limit,
													"offset": e.curr,
												});
											}
										}
									})
								})
								//表格渲染
							var strs = '';
							if(msg.data.length > 0) {
								for(var i = 0; i < msg.data.length; i++) {
									strs += '<tr class="gradeX">' +
										'<td class="data_name">' + msg.data[i].student_name + '</td>' +
										'<td class="center data_id">' + msg.data[i].relation + '</td>' +
										'<td class="center data_name">' + msg.data[i].parent_name + '</td>' +
										'<td class="center">' + msg.data[i].parent_phone + '</td>' +
										'<td><i class="fa fa-pencil areapen" title="修改"></i>&nbsp;&nbsp;<i class="fa fa-close" id=' + msg.data[i].id + ' title="删除"></i></td>' +
										'</tr>'
								}
								$("#tbody").html(strs);
							} else {
								$("#tbody").html('<tr><td colspan="5" style="text-align:center;font-size:18px;color:#666;padding:50px;background:#fff;height:318px;">暂无数据！</td></tr>');
							}
						},
						error: function() {
							console.log("error");
						}
					});
				}

				//查询
				$("#searchBtn").click(function() {
					if($("#class-name")=='--请选择班级--'||'---无---'){
						$("#class-name")='';
					}
					if($("#grade-name")=='--请选择年级--'||'---无---'){
						$("#grade-name")='';
					}
					getAjaxData({
						"class_id": $("#class-name").val() == '' ? undefined : $("#class-name").val(),
						"grade_id": $("#grade-name").val() == '' ? undefined : $("#grade-name").val(),
						"student_name": $("#student-name").val() == '' ? undefined : $("#student-name").val(),
						"parent_name": $("#parent-name").val() == '' ? undefined : $("#parent-name").val(),
						"parent_phone": $("#parent-phone").val() == '' ? undefined : $("#parent-phone").val(),
						"limit": 20,
						"offset": 1,
					});
				});

				//添加校验
				var layerIndex;
				$("#add_grade").click(function() {
					$(".selectPart .errorPartS").css("display", "none");
				});
				$("#addInfoContentform").validate({
					focusCleanup: true,
					focusInvalid: false,
					debug: true,
					rules: {
						add_name: {
							required: true,
						}
					},
					messages: {
						add_name: {
							required: '必填',
						},
					},
					submitHandler: function(form) {
						if($("#add_grade").val() != '') {
							var data = {
								'name': $("#add_name").val(),
								'grade_id': $("#add_grade").val(),
								'cardcode': cardcode,
								'describe': $("#add_remarks").val() == '' ? undefined : $("#add_remarks").val(),
							}
							$.ajax({
								type: "POST",
								contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
								url: "/class/input",
								async: false,
								data: data,
								timeout: "30000",
								success: function(msg) {
									layer.closeAll();
									layer.msg('添加成功', {
										icon: 1,
										time: 800 //2s后自动关闭
									});
									window.location.reload();
								},
								error: function() {
									layer.msg('添加失败');
									console.log("error");
								}
							});
						} else {
							$(".selectPart .errorPartS").css("display", "block");
						}
					},
					errorPlacement: function(error, element) {
						error.appendTo(element.parent().find(".errorPart"));
					},
					success: function() {}
				});

				//添加弹框
				$('#addInfo').click(function() {
					$("input").val("");
					$(".errorPart").html("");
					$("#add_grade").html('<option value="">--请选择年级--</option>');
					$("#add_class").html('<option value="">--请选择班级--</option>');
					$(".selectPart .errorPartS").css("display", "none");
					gradeInput();
					layerIndex = layer.open({
						title: '添加班级',
						type: 1,
						skin: 'layui-layer-demo',
						anim: 2,
						shadeClose: true,
						btn: ['确定', '取消'],
						content: $('#addInfoContent'),
						yes: function() {
							$("#addInfoContentSubmit").click();
							if($("#add_grade").val() == '') {
								$(".selectPart .errorPartS").css("display", "block");
							}
						}
					});
				});

				//编辑校验
				$("#editAreaContentform").validate({
					focusCleanup: true,
					focusInvalid: false,
					debug: true,
					rules: {
						edit_name: {
							required: true,
						},
						edit_school_id: {
							required: true,
						},
					},
					messages: {
						edit_name: {
							required: '必填',
						},
						edit_school_id: {
							required: '必填',
						},
					},
					submitHandler: function(form) {
						if($("#edit_grade").val() != '') {
							var data = {
								'name': $("#edit_name").val(),
								'grade_id': $("#edit_grade").val(),
								'cardcode': cardcode,
								'describe': $("#edit_remarks").val() == '' ? undefined : $("#edit_remarks").val(),
							}
							$.ajax({
								type: "POST",
								contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
								url: "/class/update",
								async: false,
								data: data,
								timeout: "30000",
								success: function(msg) {
									layer.closeAll();
									layer.msg('编辑成功', {
										icon: 1,
										time: 800 //2s后自动关闭
									});
									window.location.reload();
								},
								error: function() {
									layer.msg('编辑失败');
									console.log("error");
								}
							});
						} else {
							$(".selectPart .errorPartS").css("display", "block");
						}
					},

					errorPlacement: function(error, element) {
						error.appendTo(element.parent().find(".errorPart"));
					},
					success: function() {}
				});

				//编辑弹框
				$('.areapen').click(function() {
					$("input").val("");
					$(".errorPart").html("");
					$(".selectPart .errorPartS").css("display", "none");

					$("#edit_name").val($(this).parent("td").siblings(".data_name").html());
					console.log($(this).parent("td").siblings(".data_grade_name").attr("name"));
					$("#edit_grade").val($(this).parent("td").siblings(".data_grade_name").attr("name"));
					layerIndex = layer.open({
						title: '修改班级信息',
						type: 1,
						skin: 'layui-layer-demo',
						closeBtn: 0,
						anim: 2,
						shadeClose: true,
						btn: ['确定', '取消'],
						content: $('#editAreaContent'),
						yes: function() {
							$("#editAreaContentSubmit").click();
							if($("#edit_grade").val() == '') {
								$(".selectPart .errorPartS").css("display", "block");
							}
						}
					});
				});

				//删除
				$('#tbody .fa-close').click(function() {
					var deleteId = $(this).attr('id');
					layer.confirm('确定删除选中的学生？', {
						btn: ['确定', '取消']
					}, function() {
						var data = {
							'id': deleteId
						}
						$.ajax({
							type: "POST",
							contentType: "application/x-www-form-urlencoded;chartset=UTF-8",
							url: "/student/delete",
							async: false,
							data: data,
							timeout: "30000",
							success: function(msg) {
								layer.closeAll();
								layer.msg('删除成功', {
									icon: 1,
									time: 800 //2s后自动关闭
								});
								window.location.reload();
							},
							error: function() {
								layer.msg('删除失败');
								console.log("error");
							}
						});
					});
				});
				
				//添加弹框日期
			    function TimeSelectOption(showDateId, reportrangeId) {
					var dataStatus = "";
					//showDateId.html(moment().subtract('hours', 1).format('YYYY-MM-DD') + ' 至 ' + moment().format('YYYY-MM-DD'));
					var oldSelTime = window.sessionStorage.getItem('commonTime'); //获取其他页面设置的选择的日期
					if(oldSelTime == null || oldSelTime == "") {
						oldSelTime = moment().format('YYYY-MM-DD') + ' 至 ' + moment().format('YYYY-MM-DD');
					} else {
						oldSelTime = oldSelTime;
					}
					showDateId.html(oldSelTime);
					reportrangeId.daterangepicker({
						startDate: oldSelTime.split(' 至 ')[0], //空格不能删除，上级返回的日期如：“2016-12-16 至 2016-12-22”‘至’左右有空格
						endDate: oldSelTime.split(' 至 ')[1],
						//minDate: '01/01/2012',	//最小时间
						maxDate: moment(), //最大时间 
						dateLimit: {
							days: 31
						}, //起止时间的最大间隔
						showDropdowns: true,
						showWeekNumbers: false, //是否显示第几周
						timePicker: true, //是否显示小时和分钟
						timePickerIncrement: 60, //时间的增量，单位为分钟
						timePicker12Hour: false, //是否使用12小时制来显示时间
						timePickerIncrement: 1,
						timePicker: true,
						ranges: {
							//'最近1小时': [moment().subtract('hours',1), moment()],
							'今日': [moment().startOf('day'), moment()],
							'昨日': [moment().subtract('days', 1).startOf('day'), moment().subtract('days', 1).endOf('day')],
							'最近7日': [moment().subtract('days', 6), moment()],
							'最近30日': [moment().subtract('days', 29), moment()],
							'上周': [moment().weekday(-6).startOf('day'), moment().weekday(0).endOf('day')],
							'上月': [moment().date(-1).date(1).startOf('day'), moment().date(0).endOf('day')]
						},
						opens: 'right', //日期选择框的弹出位置
						buttonClasses: ['btn btn-default'],
						applyClass: 'btn-small btn-primary blue',
						cancelClass: 'btn-small',
						format: 'YYYY-MM-DD', //控件中from和to 显示的日期格式
						separator: ' to ',
						locale: {
							applyLabel: '确定',
							cancelLabel: '取消',
							fromLabel: '起始时间',
							toLabel: '结束时间',
							customRangeLabel: '自定义',
							daysOfWeek: ['日', '一', '二', '三', '四', '五', '六'],
							monthNames: ['一月', '二月', '三月', '四月', '五月', '六月',
								'七月', '八月', '九月', '十月', '十一月', '十二月'
							],
							firstDay: 1
						}
					}, function(start, end, label) { //格式化日期显示框
						showDateId.html(start.format('YYYY-MM-DD') + ' 至 ' + end.format('YYYY-MM-DD'));
					});
				};
			});
		</script>
	</body>

</html>